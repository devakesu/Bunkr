name: Version Bump Reminder

on:
  pull_request:
    types: [opened]
    branches: [main]

permissions:
  pull-requests: write

jobs:
  fork-reminder:
    name: Fork PR Reminder
    runs-on: ubuntu-latest
    # Only run for fork PRs (not same-repo)
    if: github.event.pull_request.head.repo.full_name != github.repository
    steps:
      - name: Checkout base branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.base_ref }}
      
      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
      
      - name: Check if version needs bump
        id: check
        run: |
          set -euo pipefail
          
          # Get version from base branch (main)
          BASE_VERSION=$(node -p "require('./package.json').version")
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "Base version: ${BASE_VERSION}"
      
      - name: Comment with manual bump instructions
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const baseVersion = '${{ steps.check.outputs.base_version }}';
            
            // Calculate next version (simple patch increment)
            const parts = baseVersion.split('.').map(Number);
            parts[2] += 1;
            if (parts[2] > 9) {
              parts[2] = 0;
              parts[1] += 1;
              if (parts[1] > 9) {
                parts[1] = 0;
                parts[0] += 1;
              }
            }
            const suggestedVersion = parts.join('.');
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ‘‹ **Thank you for your contribution from a fork!**

            Since this PR is from a forked repository, the automatic version bump cannot run (for security reasons).
            
            **Please manually bump the version before merging:**
            
            \`\`\`bash
            # Current version on main: ${baseVersion}
            # Suggested next version: ${suggestedVersion}
            
            # Run the version bump script:
            node scripts/bump-version.js
            \`\`\`
            
            The script will update:
            - \`package.json\` and \`package-lock.json\`
            - \`.example.env\` (NEXT_PUBLIC_APP_VERSION)
            - \`public/api-docs/openapi.yaml\`
            
            **Rollover versioning:** X.Y.Z where X, Y, Z âˆˆ {0-9}
            - Example: 1.6.9 â†’ 1.7.0, 1.9.9 â†’ 2.0.0
            
            For more details, see [VERSIONING.md](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/VERSIONING.md).`
            });
