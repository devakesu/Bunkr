name: Auto Version Bump

on:
  pull_request:
    # Triggers on opened and reopened to handle both new PRs and PRs that were closed/reopened
    # The check step will detect if version is already bumped and skip if not needed
    types: [opened, reopened]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-bump:
    name: Auto Bump Version
    runs-on: ubuntu-latest
    steps:
      - name: Determine if same-repo or fork
        id: repo-check
        run: |
          if [ "${{ github.event.pull_request.head.repo.full_name }}" = "${{ github.repository }}" ]; then
            echo "is_same_repo=true" >> $GITHUB_OUTPUT
            echo "‚úì Same-repo PR - can auto-commit version bump"
          else
            echo "is_same_repo=false" >> $GITHUB_OUTPUT
            echo "‚úì Fork PR - will provide manual instructions"
          fi

      - name: Checkout PR branch (same-repo only)
        if: steps.repo-check.outputs.is_same_repo == 'true'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Checkout base branch (fork PR)
        if: steps.repo-check.outputs.is_same_repo == 'false'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.base_ref }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
      
      - name: Check if version needs bump
        id: check
        run: |
          set -euo pipefail
          
          # Get current version from PR branch (or base for fork)
          if [ "${{ steps.repo-check.outputs.is_same_repo }}" = "true" ]; then
            CURRENT=$(node -p "require('./package.json').version")
            echo "Current version on PR branch: ${CURRENT}"
          else
            # For fork PRs, we check base branch version
            CURRENT=$(node -p "require('./package.json').version")
            echo "Current version on base branch: ${CURRENT}"
          fi
          
          # Get version from main branch
          git fetch origin main
          MAIN_VERSION=$(git show origin/main:package.json | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')).version")
          echo "Version on main branch: ${MAIN_VERSION}"
          
          # Calculate next version for reference
          NEXT_VERSION=$(node -e "
            const version = '${MAIN_VERSION}';
            let parts = version.split('.').map(Number);
            
            // Normalize first
            if (parts[2] > 9) { parts[2] = 0; parts[1] += 1; }
            if (parts[1] > 9) { parts[1] = 0; parts[0] += 1; parts[2] = 0; }
            
            // Increment
            parts[2] += 1;
            if (parts[2] > 9) {
              parts[2] = 0;
              parts[1] += 1;
              if (parts[1] > 9) {
                parts[1] = 0;
                parts[0] += 1;
              }
            }
            console.log(parts.join('.'));
          ")
          echo "next_version=${NEXT_VERSION}" >> $GITHUB_OUTPUT
          
          # Check if version needs bump or already bumped
          if [ "$CURRENT" = "$MAIN_VERSION" ]; then
            echo "needs_bump=true" >> $GITHUB_OUTPUT
            echo "current_version=$MAIN_VERSION" >> $GITHUB_OUTPUT
            echo "‚úì Version needs bump (matches main: ${MAIN_VERSION})"
          else
            echo "needs_bump=false" >> $GITHUB_OUTPUT
            echo "current_version=$CURRENT" >> $GITHUB_OUTPUT
            echo "‚úì Version already bumped (current: ${CURRENT}, main: ${MAIN_VERSION})"
          fi
      
      - name: Auto bump version (same-repo only)
        if: steps.repo-check.outputs.is_same_repo == 'true' && steps.check.outputs.needs_bump == 'true'
        id: bump
        run: |
          set -euo pipefail
          
          echo "Running bump-version.js script..."
          
          # Set environment for PR context
          export GITHUB_HEAD_REF="${{ github.head_ref }}"
          export CI="true"
          
          # Run the bump script
          node scripts/bump-version.js
          
          # Get the new version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "‚úì Version bumped to ${NEW_VERSION}"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Stage and commit changes
          # Note: Files are explicitly listed (not git add -u) to ensure only version files are committed
          # This matches the files updated by bump-version.js
          git add package.json package-lock.json .example.env public/api-docs/openapi.yaml
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è  No changes to commit after running bump script"
            exit 0
          fi
          
          git commit -m "chore: auto-bump version to v${NEW_VERSION}"
          git push
          
          echo "‚úì Changes committed and pushed"
      
      - name: Comment on PR (same-repo with auto-bump)
        if: steps.repo-check.outputs.is_same_repo == 'true' && steps.check.outputs.needs_bump == 'true' && steps.bump.outputs.new_version != ''
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const newVersion = '${{ steps.bump.outputs.new_version }}';
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ **Version automatically bumped to \`v${newVersion}\`**

            This PR now includes the version bump commit.
            
            **Rollover versioning:** X.Y.Z where X, Y, Z ‚àà {0-9}
            - Example: 1.6.9 ‚Üí 1.7.0, 1.9.9 ‚Üí 2.0.0
            
            This PR is ready for review! üöÄ`
            });
      
      - name: Comment on PR (same-repo, already bumped)
        if: steps.repo-check.outputs.is_same_repo == 'true' && steps.check.outputs.needs_bump == 'false'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const currentVersion = '${{ steps.check.outputs.current_version }}';
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ **Version already bumped to \`v${currentVersion}\`**

            No automatic version bump needed - the PR already includes a version update.
            
            This PR is ready for review! üöÄ`
            });
      
      - name: Comment on PR (fork, needs bump)
        if: steps.repo-check.outputs.is_same_repo == 'false' && steps.check.outputs.needs_bump == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const nextVersion = '${{ steps.check.outputs.next_version }}';
            const currentVersion = '${{ steps.check.outputs.current_version }}';
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üëã **Thank you for your contribution from a fork!**

            Since this PR is from a forked repository, the automatic version bump cannot run (for security reasons).
            
            **Please manually bump the version before merging:**
            
            \`\`\`bash
            # Current version on main: ${currentVersion}
            # Suggested next version: ${nextVersion}
            
            # Run the version bump script:
            node scripts/bump-version.js
            \`\`\`
            
            The script will update:
            - \`package.json\` and \`package-lock.json\`
            - \`.example.env\` (NEXT_PUBLIC_APP_VERSION)
            - \`public/api-docs/openapi.yaml\`
            
            **Rollover versioning:** X.Y.Z where X, Y, Z ‚àà {0-9}
            - Example: 1.6.9 ‚Üí 1.7.0, 1.9.9 ‚Üí 2.0.0
            
            For more details, see [VERSIONING.md](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/VERSIONING.md).`
            });
      
      - name: Comment on PR (fork, already bumped)
        if: steps.repo-check.outputs.is_same_repo == 'false' && steps.check.outputs.needs_bump == 'false'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const currentVersion = '${{ steps.check.outputs.current_version }}';
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ **Version already bumped to \`v${currentVersion}\`**

            Great! This PR already includes a version update.
            
            This PR is ready for review! üöÄ`
            });
