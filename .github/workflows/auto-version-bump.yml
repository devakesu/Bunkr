name: Auto Version Bump

on:
  pull_request:
    # Triggers on opened and reopened to handle both new PRs and PRs that were closed/reopened
    # The check step will detect if version is already bumped and skip if not needed
    types: [opened, reopened]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-bump:
    name: Auto Bump Version
    runs-on: ubuntu-latest
    # Only run for same-repo PRs (not forks) for security
    if: github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
      
      - name: Check if version needs bump
        id: check
        run: |
          set -euo pipefail
          
          # Get current version from PR branch
          CURRENT=$(node -p "require('./package.json').version")
          echo "Current version on PR branch: ${CURRENT}"
          
          # Get version from main branch
          git fetch origin main
          MAIN_VERSION=$(git show origin/main:package.json | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')).version")
          echo "Version on main branch: ${MAIN_VERSION}"
          
          # If versions match, we need to bump
          if [ "$CURRENT" = "$MAIN_VERSION" ]; then
            echo "needs_bump=true" >> $GITHUB_OUTPUT
            echo "current_version=$MAIN_VERSION" >> $GITHUB_OUTPUT
            echo "‚úì Version needs bump (matches main: ${MAIN_VERSION})"
          else
            echo "needs_bump=false" >> $GITHUB_OUTPUT
            echo "‚úì Version already bumped (PR: ${CURRENT}, main: ${MAIN_VERSION})"
          fi
      
      - name: Auto bump version
        if: steps.check.outputs.needs_bump == 'true'
        id: bump
        run: |
          set -euo pipefail
          
          echo "Running bump-version.js script..."
          
          # Set environment for PR context
          export GITHUB_HEAD_REF="${{ github.head_ref }}"
          export CI="true"
          
          # Run the bump script
          node scripts/bump-version.js
          
          # Get the new version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "‚úì Version bumped to ${NEW_VERSION}"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Stage and commit changes
          # Note: Files are explicitly listed (not git add -u) to ensure only version files are committed
          # This matches the files updated by bump-version.js
          git add package.json package-lock.json .example.env public/api-docs/openapi.yaml
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è  No changes to commit after running bump script"
            exit 0
          fi
          
          git commit -m "chore: auto-bump version to v${NEW_VERSION}"
          git push
          
          echo "‚úì Changes committed and pushed"
      
      - name: Comment on PR
        if: steps.check.outputs.needs_bump == 'true' && steps.bump.outputs.new_version != ''
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const newVersion = '${{ steps.bump.outputs.new_version }}';
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ **Version automatically bumped to \`v${newVersion}\`**

            This PR now includes the version bump commit.
            
            **Rollover versioning:** X.Y.Z where X, Y, Z ‚àà {0-9}
            - Example: 1.6.9 ‚Üí 1.7.0, 1.9.9 ‚Üí 2.0.0
            
            This PR is ready for review! üöÄ`
            });
